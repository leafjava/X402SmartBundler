# Gas è´¹ä¼˜åŒ–å™¨ - å®Œæ•´æµç¨‹è¯´æ˜

## ğŸ¯ å®Œæ•´çš„äº¤æ˜“æµç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥éœ€æ±‚
    â†“
ç‚¹å‡»"å¼€å§‹åˆ†æ"
    â†“
è°ƒç”¨ Coze AI è·å–ä¼˜åŒ–æ–¹æ¡ˆ
    â†“
æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢ï¼ˆ0.1 ETHï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡»"æ”¯ä»˜å’¨è¯¢è´¹"
    â†“
è°ƒç”¨åˆçº¦ paymentConsultationFee()
    â†“
æ”¯ä»˜æˆåŠŸï¼Œæ˜¾ç¤ºä¼˜åŒ–æ–¹æ¡ˆ
    â†“
ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œå…‘æ¢"
    â†“
ä½¿ç”¨ AI è¿”å›çš„ tx æ•°æ®æ‰§è¡Œäº¤æ˜“
    â†“
äº¤æ˜“å®Œæˆ
```

## ğŸ“ è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 1: ç”¨æˆ·è¾“å…¥éœ€æ±‚

**ç”¨æˆ·æ“ä½œ**:
```
è¾“å…¥: "å¸®æˆ‘æŠŠ 1 ETH æ¢æˆ USDC"
ç‚¹å‡»: "å¼€å§‹åˆ†æ"
```

**å‰ç«¯å¤„ç†**:
```typescript
const handleAnalyze = async () => {
  // 1. éªŒè¯è¾“å…¥å’Œé’±åŒ…è¿æ¥
  if (!prompt.trim()) return;
  if (!isConnected) return;
  
  // 2. è°ƒç”¨ AI API
  const optimization = await fetchOptimization(prompt);
  
  // 3. ä¿å­˜ç»“æœå¹¶æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
  setResult(optimization);
  setShowPayment(true);
}
```

### æ­¥éª¤ 2: è°ƒç”¨ Coze AI

**API è¯·æ±‚**:
```
POST /api/optimize-gas
Body: {
  "prompt": "å¸®æˆ‘æŠŠ 1 ETH æ¢æˆ USDC",
  "userAddress": "0x..."
}
```

**åç«¯å¤„ç†**:
```typescript
// app/api/optimize-gas/route.ts
import { sendCozeMessage } from '../../../lib/coze-api';

// è°ƒç”¨ Coze APIï¼ˆè½®è¯¢æ¨¡å¼ï¼‰
const cozeResponse = await sendCozeMessage(prompt, userAddress);

// è§£æ JSON å“åº”
const result = JSON.parse(cozeResponse);

// å¦‚æœæœ‰ route ä½†æ²¡æœ‰ txï¼Œè‡ªåŠ¨æ„å»º tx
if (result.data.route && !result.data.tx) {
  result.data.tx = buildTxData(result.data);
}

return result;
```

**Coze API è¿”å›**:
```json
{
  "ok": true,
  "error": null,
  "data": {
    "chain_id": 8453,
    "input_token": "ETH",
    "output_token": "USDC",
    "amount_in": "1000000000000000000",
    "amount_out_min": "2900000000",
    "slippage_bps": 100,
    "route": [{
      "protocol": "uniswap-v3",
      "pool_address": "0xPoolMock1",
      "fee_tier": 3000,
      "portion_bps": 10000,
      "token_in": "ETH",
      "token_out": "USDC",
      "amount_in": "1000000000000000000",
      "amount_out": "2920500000"
    }],
    "tx": {
      "to": "0xPoolMock1",
      "data": "0x38ed1739...",
      "value": "1000000000000000000",
      "gas": "210000",
      "maxFeePerGas": "2000000000",
      "maxPriorityFeePerGas": "150000000"
    }
  }
}
```

### æ­¥éª¤ 3: æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢

**å‰ç«¯æ˜¾ç¤º**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¯ä»˜å’¨è¯¢è´¹                      â”‚
â”‚  AI å·²åˆ†ææ‚¨çš„éœ€æ±‚ï¼Œæ”¯ä»˜åå³å¯   â”‚
â”‚  è·å–æœ€ä¼˜è·¯å¾„                    â”‚
â”‚                                  â”‚
â”‚  0.1 ETH                         â”‚
â”‚  (çº¦ $XXX)                       â”‚
â”‚                                  â”‚
â”‚  [æ”¯ä»˜å’¨è¯¢è´¹] æŒ‰é’®               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 4: æ”¯ä»˜å’¨è¯¢è´¹

**ç”¨æˆ·æ“ä½œ**:
```
ç‚¹å‡»: "æ”¯ä»˜å’¨è¯¢è´¹"
```

**å‰ç«¯å¤„ç†**:
```typescript
const handlePayConsultation = async () => {
  // åˆçº¦åœ°å€
  const contractAddress = '0xb81173637860c9B9Bf9c20b07d1c270A9A434373';
  
  // è°ƒç”¨ paymentConsultationFee å‡½æ•°
  const paymentTx = await window.ethereum.request({
    method: 'eth_sendTransaction',
    params: [{
      from: address,
      to: contractAddress,
      data: '0xb4cb0352', // paymentConsultationFee() å‡½æ•°é€‰æ‹©å™¨
      value: '0x16345785d8a0000', // 0.1 ETH
    }],
  });
  
  // æ”¯ä»˜æˆåŠŸï¼Œæ˜¾ç¤ºä¼˜åŒ–æ–¹æ¡ˆ
  setShowPayment(false);
}
```

**åˆçº¦è°ƒç”¨**:
```solidity
// FundMe.sol
function paymentConsultationFee() external payable {
    // æ£€æŸ¥æ”¯ä»˜é‡‘é¢æ˜¯å¦è¶³å¤Ÿ
    require(msg.value >= MINI_USD, "didn't send enough ETH");
    
    // è®°å½•æ”¯ä»˜è€…
    funders.push(msg.sender);
    addressToAmountFunded[msg.sender] += msg.value;
}
```

**MetaMask å¼¹çª—**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¡®è®¤äº¤æ˜“                        â”‚
â”‚                                  â”‚
â”‚  åˆçº¦: 0xb811...4373             â”‚
â”‚  å‡½æ•°: paymentConsultationFee()  â”‚
â”‚  é‡‘é¢: 0.1 ETH                   â”‚
â”‚  Gas: ~21000                     â”‚
â”‚                                  â”‚
â”‚  [æ‹’ç»] [ç¡®è®¤]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 5: æ˜¾ç¤ºä¼˜åŒ–æ–¹æ¡ˆ

**å‰ç«¯æ˜¾ç¤º**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ä¼˜åŒ–æ–¹æ¡ˆå·²ç”Ÿæˆ               â”‚
â”‚                                  â”‚
â”‚  è¾“å…¥ä»£å¸: ETH                   â”‚
â”‚  è¾“å‡ºä»£å¸: USDC                  â”‚
â”‚  è¾“å…¥æ•°é‡: 1.0000 ETH            â”‚
â”‚  æœ€å°è¾“å‡º: 2900.00 USDC          â”‚
â”‚  æ»‘ç‚¹: 1%                        â”‚
â”‚  é¢„ä¼° Gas: 210000                â”‚
â”‚                                  â”‚
â”‚  [æ‰§è¡Œå…‘æ¢] æŒ‰é’®                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 6: æ‰§è¡Œå…‘æ¢

**ç”¨æˆ·æ“ä½œ**:
```
ç‚¹å‡»: "æ‰§è¡Œå…‘æ¢"
```

**å‰ç«¯å¤„ç†**:
```typescript
const handleExecuteSwap = async () => {
  const tx = result.data.tx;
  
  // å‘é€äº¤æ˜“
  const txHash = await window.ethereum.request({
    method: 'eth_sendTransaction',
    params: [{
      from: address,
      to: tx.to,              // 0xPoolMock1
      data: tx.data,          // 0x38ed1739...
      value: tx.value,        // 1000000000000000000
      gas: tx.gas,            // 210000
      maxFeePerGas: tx.maxFeePerGas,
      maxPriorityFeePerGas: tx.maxPriorityFeePerGas,
    }],
  });
  
  setTxHash(txHash);
}
```

**MetaMask å¼¹çª—**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¡®è®¤äº¤æ˜“                        â”‚
â”‚                                  â”‚
â”‚  åˆçº¦: 0xPool...Mock1            â”‚
â”‚  å‡½æ•°: swapExactETHForTokens()   â”‚
â”‚  é‡‘é¢: 1.0 ETH                   â”‚
â”‚  Gas: 210000                     â”‚
â”‚                                  â”‚
â”‚  é¢„ä¼°è¾“å‡º: ~2920.5 USDC          â”‚
â”‚  æœ€å°è¾“å‡º: 2900.0 USDC           â”‚
â”‚                                  â”‚
â”‚  [æ‹’ç»] [ç¡®è®¤]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 7: äº¤æ˜“å®Œæˆ

**å‰ç«¯æ˜¾ç¤º**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… äº¤æ˜“æˆåŠŸï¼                   â”‚
â”‚                                  â”‚
â”‚  äº¤æ˜“å“ˆå¸Œ:                       â”‚
â”‚  0x1234567890abcdef...           â”‚
â”‚                                  â”‚
â”‚  [åœ¨åŒºå—æµè§ˆå™¨æŸ¥çœ‹]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” å…³é”®æ•°æ®æµ

### 1. AI å“åº”æ•°æ®

**è¾“å…¥ (Coze)**:
```json
{
  "prompt": "å¸®æˆ‘æŠŠ 1 ETH æ¢æˆ USDC",
  "userAddress": "0x..."
}
```

**è¾“å‡º (Coze)**:
```json
{
  "ok": true,
  "data": {
    "amount_in": "1000000000000000000",
    "amount_out_min": "2900000000",
    "route": [...],
    "tx": {...}
  }
}
```

### 2. æ”¯ä»˜å’¨è¯¢è´¹äº¤æ˜“

**äº¤æ˜“æ•°æ®**:
```javascript
{
  from: "0xç”¨æˆ·åœ°å€",
  to: "0xb81173637860c9B9Bf9c20b07d1c270A9A434373",
  data: "0xb4cb0352",
  value: "0x16345785d8a0000" // 0.1 ETH
}
```

**å‡½æ•°ç­¾å**:
```
paymentConsultationFee()
Selector: 0xb4cb0352
```

### 3. æ‰§è¡Œå…‘æ¢äº¤æ˜“

**äº¤æ˜“æ•°æ®**:
```javascript
{
  from: "0xç”¨æˆ·åœ°å€",
  to: "0xPoolMock1",
  data: "0x38ed1739" + 
        "0000...0de0b6b3a7640000" +  // amount_in
        "0000...acda7d00",            // amount_out_min
  value: "1000000000000000000" // 1 ETH
}
```

**å‡½æ•°ç­¾å**:
```
swapExactETHForTokens(uint256 amountIn, uint256 amountOutMin)
Selector: 0x38ed1739
```

## ğŸ“Š çŠ¶æ€ç®¡ç†

```typescript
// å‰ç«¯çŠ¶æ€
const [prompt, setPrompt] = useState('');           // ç”¨æˆ·è¾“å…¥
const [loading, setLoading] = useState(false);      // åŠ è½½çŠ¶æ€
const [showPayment, setShowPayment] = useState(false); // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
const [result, setResult] = useState(null);         // AI è¿”å›ç»“æœ
const [txHash, setTxHash] = useState('');           // äº¤æ˜“å“ˆå¸Œ
```

**çŠ¶æ€è½¬æ¢**:
```
åˆå§‹çŠ¶æ€
  â†“ handleAnalyze()
åŠ è½½ä¸­ (loading=true)
  â†“ AI è¿”å›
æ˜¾ç¤ºæ”¯ä»˜ (showPayment=true, result=data)
  â†“ handlePayConsultation()
æ”¯ä»˜ä¸­ (loading=true)
  â†“ æ”¯ä»˜æˆåŠŸ
æ˜¾ç¤ºç»“æœ (showPayment=false, result=data)
  â†“ handleExecuteSwap()
æ‰§è¡Œä¸­ (loading=true)
  â†“ äº¤æ˜“æˆåŠŸ
å®Œæˆ (txHash=hash)
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡ç¯å¢ƒ

```bash
# ç¡®ä¿æœ‰æµ‹è¯•ç½‘ ETH
# ç¡®ä¿é’±åŒ…å·²è¿æ¥
# ç¡®ä¿ Coze API Token å·²é…ç½®
```

### 2. æµ‹è¯•æµç¨‹

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨
npm run dev

# 2. è®¿é—®é¡µé¢
http://localhost:3000/gas-optimizer

# 3. è¿æ¥é’±åŒ…
ç‚¹å‡»å³ä¸Šè§’ "Connect"

# 4. è¾“å…¥éœ€æ±‚
"å¸®æˆ‘æŠŠ 1 ETH æ¢æˆ USDC"

# 5. å¼€å§‹åˆ†æ
ç‚¹å‡» "å¼€å§‹åˆ†æ"
æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ï¼š
  - ğŸ” å¼€å§‹è°ƒç”¨ AI åˆ†æéœ€æ±‚...
  - âœ… AI è¿”å›ä¼˜åŒ–æ–¹æ¡ˆ: {...}
  - ğŸ’¡ AI åˆ†æå®Œæˆï¼Œè¯·æ”¯ä»˜å’¨è¯¢è´¹

# 6. æ”¯ä»˜å’¨è¯¢è´¹
ç‚¹å‡» "æ”¯ä»˜å’¨è¯¢è´¹"
åœ¨ MetaMask ä¸­ç¡®è®¤
æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ï¼š
  - ğŸ’° å¼€å§‹æ”¯ä»˜å’¨è¯¢è´¹...
  - ğŸ“Š AI ä¼˜åŒ–æ–¹æ¡ˆ: {...}
  - âœ… æ”¯ä»˜äº¤æ˜“å·²å‘é€: 0x...

# 7. æ‰§è¡Œå…‘æ¢
ç‚¹å‡» "æ‰§è¡Œå…‘æ¢"
åœ¨ MetaMask ä¸­ç¡®è®¤
æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ï¼š
  - å¼€å§‹æ‰§è¡Œå…‘æ¢...
  - AI è¿”å›çš„æ•°æ®: {...}
  - äº¤æ˜“æˆåŠŸ: 0x...
```

### 3. éªŒè¯ç»“æœ

```bash
# æŸ¥çœ‹æ”¯ä»˜äº¤æ˜“
https://sepolia.etherscan.io/tx/æ”¯ä»˜äº¤æ˜“å“ˆå¸Œ

# æŸ¥çœ‹å…‘æ¢äº¤æ˜“
https://sepolia.etherscan.io/tx/å…‘æ¢äº¤æ˜“å“ˆå¸Œ

# æ£€æŸ¥åˆçº¦çŠ¶æ€
https://sepolia.etherscan.io/address/0xb81173637860c9B9Bf9c20b07d1c270A9A434373
```

## âœ… å®Œæˆæ¸…å•

- [x] ç”¨æˆ·è¾“å…¥éœ€æ±‚
- [x] è°ƒç”¨ Coze AI è·å–ä¼˜åŒ–æ–¹æ¡ˆ
- [x] æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
- [x] è°ƒç”¨åˆçº¦æ”¯ä»˜å’¨è¯¢è´¹
- [x] æ˜¾ç¤ºä¼˜åŒ–æ–¹æ¡ˆ
- [x] æ‰§è¡Œå…‘æ¢äº¤æ˜“
- [x] æ˜¾ç¤ºäº¤æ˜“ç»“æœ

## ğŸ‰ æ€»ç»“

ç°åœ¨æ•´ä¸ªæµç¨‹å·²ç»å®Œæ•´å®ç°ï¼š

1. âœ… ç”¨æˆ·è¾“å…¥éœ€æ±‚
2. âœ… AI åˆ†æå¹¶è¿”å›ä¼˜åŒ–æ–¹æ¡ˆ
3. âœ… ç”¨æˆ·æ”¯ä»˜å’¨è¯¢è´¹ï¼ˆè°ƒç”¨åˆçº¦ï¼‰
4. âœ… æ˜¾ç¤ºä¼˜åŒ–æ–¹æ¡ˆ
5. âœ… æ‰§è¡Œå…‘æ¢äº¤æ˜“

æ‰€æœ‰åŠŸèƒ½éƒ½å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼ğŸš€
